
-- Autor: Monica Pellegrini. Fecha:27.07.2016

VARIABLE FECHA_DESDE VARCHAR2(15);
VARIABLE FECHA_HASTA VARCHAR2(15);
VARIABLE MASCARA     VARCHAR2(15);


EXEC :FECHA_DESDE := '&1';
EXEC :FECHA_HASTA := '&2';
EXEC :MASCARA     := 'DD.MM.YYYY';



DELETE TABLERO_NQI_DAY
 WHERE ELEMENT_CLASS ='MERCADO'
   AND FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND ELEMENT_TYPE ='VOZ'
   AND TECHNOLOGY ='UMTS';
 COMMIT;

INSERT INTO TABLERO_NQI_DAY
SELECT  FECHA,
        ELEMENT_CLASS,
        ELEMENT_NAME,
        ELEMENT_TYPE,
        TECHNOLOGY,
        QDA_CS,
        QDR_CS,
        ROUND(QDA_CS * QDR_CS,4)/ 100  NQI_CS
  FROM(
SELECT FECHA,
       'MERCADO'                            ELEMENT_CLASS,
       DECODE(MERCADO,NULL, 'OTRO',MERCADO) ELEMENT_NAME  ,
       'VOZ'                                ELEMENT_TYPE,
       'UMTS'                               TECHNOLOGY,
        ROUND(100 * DECODE(SUM(QDA_DEN),0 ,0,
                           SUM(QDA_NUM)/ SUM(QDA_DEN)),4) QDA_CS,
        ROUND(100 * DECODE(SUM(QDR_DEN),0 ,0,
                           SUM(QDR_NUM)/ SUM(QDR_DEN)),4) QDR_CS
  FROM UMTS_NSN_NQI_VOZ_DAY
 WHERE FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND MERCADO IS NOT NULL
GROUP BY FECHA,
         MERCADO
         )
ORDER BY FECHA ASC;

 COMMIT;

DELETE TABLERO_NQI_DAY
 WHERE ELEMENT_CLASS ='PAIS'
   AND FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND ELEMENT_TYPE ='VOZ'
   AND TECHNOLOGY ='UMTS';
  COMMIT;

INSERT INTO TABLERO_NQI_DAY
SELECT  FECHA,
        ELEMENT_CLASS,
        ELEMENT_NAME,
        ELEMENT_TYPE,
        TECHNOLOGY,
        QDA_CS,
        QDR_CS,
        ROUND(QDA_CS * QDR_CS,4)/ 100  NQI_CS
  FROM(
SELECT FECHA,
       'PAIS'                               ELEMENT_CLASS,
       DECODE(PAIS,NULL, 'OTRO',PAIS)       ELEMENT_NAME  ,
       'VOZ'                                ELEMENT_TYPE,
       'UMTS'                               TECHNOLOGY,
       ROUND(100 * DECODE(SUM(QDA_DEN),0 ,0,
                           SUM(QDA_NUM)/ SUM(QDA_DEN)),4) QDA_CS,
        ROUND(100 * DECODE(SUM(QDR_DEN),0 ,0,
                           SUM(QDR_NUM)/ SUM(QDR_DEN)),4) QDR_CS
  FROM UMTS_NSN_NQI_VOZ_DAY
 WHERE FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND PAIS IS NOT NULL
GROUP BY FECHA,
         PAIS
         )
ORDER BY FECHA ASC;

 COMMIT;

DELETE TABLERO_NQI_DAY
 WHERE ELEMENT_CLASS ='MERCADO'
   AND FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND ELEMENT_TYPE ='DATOS'
   AND TECHNOLOGY ='LTE';
  COMMIT;

INSERT INTO TABLERO_NQI_DAY
SELECT  FECHA,
        ELEMENT_CLASS,
        ELEMENT_NAME,
        ELEMENT_TYPE,
        TECHNOLOGY,
        QDA_CS,
        QDR_CS,
        ROUND(QDA_CS * QDR_CS,4)/ 100  NQI_CS
  FROM(
SELECT FECHA,
       'MERCADO'                            ELEMENT_CLASS,
       DECODE(MERCADO,NULL, 'OTRO',MERCADO) ELEMENT_NAME  ,
       'DATOS'                                ELEMENT_TYPE,
       'LTE'                               TECHNOLOGY,
        ROUND(100 * DECODE(SUM(QDA_DEN),0 ,0,
                           SUM(QDA_NUM)/ SUM(QDA_DEN)),4) QDA_CS,
        ROUND(100 * DECODE(SUM(QDR_DEN),0 ,0,
                           SUM(QDR_NUM)/ SUM(QDR_DEN)),4) QDR_CS
  FROM LTE_NQI_DAY
 WHERE FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND MERCADO IS NOT NULL
GROUP BY FECHA,
         MERCADO
         )
ORDER BY FECHA ASC;
 COMMIT;

DELETE TABLERO_NQI_DAY
 WHERE ELEMENT_CLASS ='PAIS'
   AND FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND ELEMENT_TYPE ='DATOS'
   AND TECHNOLOGY ='LTE';
    COMMIT;

INSERT INTO TABLERO_NQI_DAY
SELECT  FECHA,
        ELEMENT_CLASS,
        ELEMENT_NAME,
        ELEMENT_TYPE,
        TECHNOLOGY,
        QDA_CS,
        QDR_CS,
        ROUND(QDA_CS * QDR_CS,4)/ 100  NQI_CS
  FROM(
SELECT FECHA,
       'PAIS'                               ELEMENT_CLASS,
       DECODE(PAIS,NULL, 'OTRO',PAIS)       ELEMENT_NAME  ,
       'DATOS'                              ELEMENT_TYPE,
       'LTE'                                TECHNOLOGY,
        ROUND(100 * DECODE(SUM(QDA_DEN),0 ,0,
                           SUM(QDA_NUM)/ SUM(QDA_DEN)),4) QDA_CS,
        ROUND(100 * DECODE(SUM(QDR_DEN),0 ,0,
                           SUM(QDR_NUM)/ SUM(QDR_DEN)),4) QDR_CS
  FROM LTE_NQI_DAY
 WHERE FECHA BETWEEN TO_DATE(:FECHA_DESDE , :MASCARA)
                 AND TO_DATE(:FECHA_HASTA , :MASCARA) + 86399/86400
   AND PAIS IS NOT NULL
GROUP BY FECHA,
         PAIS
         )
ORDER BY FECHA ASC;
 COMMIT;

EXIT;

